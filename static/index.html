<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeOne</title>
    <link rel="icon" href="/static/css/favicon.png" type="image/png">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/plyr.css" />
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <div id="app" v-cloak>
        <div class="container-fluid">
            <!-- È°∂ÈÉ®ÈîôËØØÊèêÁ§∫ -->
            <div v-if="errorMsg" class="alert alert-danger position-fixed top-0 start-50 translate-middle-x mt-5"
                style="z-index: 9999;">{{ errorMsg }}</div>

            <!-- ==================== ÂàóË°®ËßÜÂõæ (È¶ñÈ°µ/ÊéíÊúü/ËøΩÁï™) ==================== -->
            <div v-if="mode !== 'player'">
                <!-- Á≠õÈÄâÂ∑•ÂÖ∑Ê†è -->
                <div class="filter-bar mb-4 mt-3"> <!-- Âä†‰∫Ü mt-3 Ë°•‰∏Ä‰∏ãÈ°∂ÈÉ®Èó¥Ë∑ù -->

                    <!-- Á¨¨‰∏ÄË°åÔºöËÉ∂ÂõäÂØºËà™ + ÊêúÁ¥¢Ê°Ü -->
                    <div class="d-flex flex-wrap align-items-center gap-3">

                        <!-- 1. ËÉ∂ÂõäÂØºËà™ÁªÑ -->
                        <div class="nav-pill-group">
                            <!-- Â≠£Â∫¶Êñ∞Áï™ -->
                            <button class="nav-pill-item" :class="{ 'active-blue': mode === 'schedule' }"
                                @click="switchMode('schedule')">
                                üìÖ Â≠£Â∫¶Êñ∞Áï™
                            </button>

                            <!-- ÂÖ®ÈÉ®Áï™Ââß -->
                            <button class="nav-pill-item" :class="{ 'active-blue': mode === 'home' }"
                                @click="switchMode('home')">
                                üè† ÂÖ®ÈÉ®Áï™Ââß
                            </button>

                            <!-- ÊàëÁöÑËøΩÁï™ -->
                            <button class="nav-pill-item" :class="{ 'active-red': mode === 'favorites' }"
                                @click="switchMode('favorites')">
                                ‚ù§Ô∏è ÊàëÁöÑËøΩÁï™
                            </button>

                            <!-- ËßÇÁúãÂéÜÂè≤ -->
                            <button class="nav-pill-item" :class="{ 'active-green': mode === 'history' }"
                                @click="switchMode('history')">
                                üïí ËßÇÁúãÂéÜÂè≤
                            </button>
                        </div>

                        <!-- 2. ÊêúÁ¥¢Ê°Ü (ÁßªÂà∞‰∫ÜËøôÈáå) -->
                        <div class="d-flex gap-2">
                            <input class="form-control form-control-sm bg-dark text-light border-secondary"
                                v-model="searchQuery" @keyup.enter="doSearch" placeholder="ÊêúÁ¥¢..."
                                style="width: 160px; border-radius: 20px; padding-left: 15px;"> <!-- ÂèòÂúÜÊ∂¶‰∫Ü -->

                            <button class="btn btn-sm btn-outline-light rounded-circle" @click="doSearch" title="ÊêúÁ¥¢">
                                üîç
                            </button>
                        </div>
                    </div>

                    <!-- Á¨¨‰∫åË°åÔºöÂ≠£Â∫¶ÈÄâÊã©Âô® (‰ªÖÂú®ÊéíÊúüÊ®°ÂºèÊòæÁ§∫) -->
                    <div v-if="mode === 'schedule'" class="d-flex gap-2 mt-3 align-items-center flex-wrap">
                        <select class="form-select form-select-sm bg-dark text-light border-secondary"
                            style="width:auto; border-radius: 15px;" v-model="selectedYear">
                            <option v-for="y in years" :key="y" :value="y">{{ y }} Âπ¥</option>
                        </select>
                        <select class="form-select form-select-sm bg-dark text-light border-secondary"
                            style="width:auto; border-radius: 15px;" v-model="selectedSeason">
                            <option value="Êò•Â≠£">Êò•Â≠£</option>
                            <option value="Â§èÂ≠£">Â§èÂ≠£</option>
                            <option value="ÁßãÂ≠£">ÁßãÂ≠£</option>
                            <option value="ÂÜ¨Â≠£">ÂÜ¨Â≠£</option>
                        </select>
                        <button class="btn btn-sm btn-primary rounded-pill px-3" @click="fetchSchedule">Êü•Áúã</button>
                    </div>
                </div>

                <!-- Âä†ËΩΩ‰∏≠ -->
                <div v-if="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>

                <!-- ËøΩÁï™Á©∫Áä∂ÊÄÅ -->
                <div v-if="mode === 'favorites' && !loading && animeList.length === 0"
                    class="text-center py-5 text-muted">
                    <h4>ÊöÇÊó†ËøΩÁï™</h4>
                    <button class="btn btn-outline-primary btn-sm mt-2" @click="switchMode('home')">ÂéªÊµèËßàÁï™Ââß</button>
                </div>

                <!-- ÂéÜÂè≤Á©∫Áä∂ÊÄÅ -->
                <div v-if="mode === 'history' && !loading && animeList.length === 0"
                    class="text-center py-5 text-muted">
                    <h4>ÊöÇÊó†ËßÇÁúãËÆ∞ÂΩï</h4>
                    <button class="btn btn-outline-primary btn-sm mt-2" @click="switchMode('home')">ÂéªÊµèËßàÁï™Ââß</button>
                </div>

                <!-- ÂàóË°®ÂÜÖÂÆπÂå∫Âüü -->
                <div v-if="!loading">
                    <!-- ÊòüÊúüÂàáÊç¢ (‰ªÖÊéíÊúüÊ®°Âºè) -->
                    <div v-if="mode === 'schedule'" class="mb-4">
                        <!-- üî• Ê∑ªÂä†ËÉ∂ÂõäÂÆπÂô®ÂåÖË£π -->
                        <div class="week-capsule-container">
                            <button v-for="(day, index) in weekDays" :key="index" class="week-pill"
                                :class="{ 'active': currentDayTab === index }" @click="currentDayTab = index">

                                {{ day }}

                                <!-- Êï∞Â≠óËßíÊ†á -->
                                <span class="badge rounded-pill ms-1"
                                    :class="currentDayTab === index ? '' : 'bg-secondary'">
                                    {{ weekData[index]?.length || 0 }}
                                </span>
                            </button>
                        </div>
                    </div>

                    <!-- Âç°ÁâáÁΩëÊ†º -->
                    <div class="row row-cols-3 row-cols-md-4 row-cols-lg-6 g-3">
                        <div class="col" v-for="anime in (mode === 'schedule' ? weekData[currentDayTab] : animeList)"
                            :key="anime.id">
                            <div class="card h-100 cover-card text-light" @click="openDetail(anime)">
                                <div class="poster-box">
                                    <div v-if="isFavorited(anime.id)" class="fav-mark">‚ù§Ô∏è</div>
                                    <div v-if="anime.posterLoading"
                                        class="loading-cover-state d-flex justify-content-center align-items-center h-100">
                                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                                    </div>
                                    <img v-else-if="anime.poster && !anime.coverFailed" :src="anime.poster"
                                        class="poster-img" loading="lazy" @error="handleImageError(anime)">
                                    <div v-else
                                        class="loading-cover-state d-flex justify-content-center align-items-center h-100 text-muted fs-4">
                                        üì∫</div>
                                </div>
                                <div class="card-body p-2">
                                    <h6 class="card-title text-truncate mb-1">{{ anime.title }}</h6>

                                    <!-- ÂæΩÁ´†Âå∫ÂüüÔºàÊ®™ÂêëÊéíÂàóÔºâ -->
                                    <div class="d-flex gap-1 flex-wrap">
                                        <!-- Áä∂ÊÄÅ/Âπ¥‰ªΩÂæΩÁ´† -->
                                        <span class="badge"
                                            :class="(anime.status && (anime.status.includes('ËøûËΩΩ') || anime.status.includes('Live'))) ? 'bg-info text-dark' : 'bg-secondary'">
                                            {{ (anime.status && (anime.status.includes('ËøûËΩΩ') || anime.status.includes('Live'))) ? anime.status : (anime.year || 'Êú™Áü•') }}
                                        </span>

                                        <!-- üî• ÊâÄÊúâÊ®°Âºè‰∏ãÈÉΩÊòæÁ§∫ËßÇÁúãËøõÂ∫¶ -->
                                        <span v-if="historyList.find(h => String(h.animeId) === String(anime.id))"
                                            class="badge bg-success text-dark">
                                            ËßÇÁúãËá≥: {{ historyList.find(h => String(h.animeId) ===
                                            String(anime.id)).episodeTitle }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üî• Âä†ËΩΩÊõ¥Â§öÊèêÁ§∫ (Êó†ÈôêÊªöÂä®) -->
                    <div class="text-center mt-4" v-if="loading && animeList.length > 0">
                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                        <span class="text-muted ms-2">Âä†ËΩΩ‰∏≠...</span>
                    </div>
                </div>
            </div>

            <!-- ==================== Êí≠ÊîæÈ°µ (Áã¨Á´ãËßÜÂõæ) ==================== -->
            <div v-if="mode === 'player' && currentAnime" class="player-container fade-in">
                <div class="row">
                    <!-- Â∑¶‰æßÔºöÊí≠ÊîæÂô®Âå∫Âüü (Âç†ÂÆΩ 9/12) -->
                    <div class="col-lg-9 col-md-12 mb-4">
                        <!-- ratio Á±ªÊèê‰æõ‰∫Ü 16:9 ÁöÑÂç†‰ΩçÔºåCSS Ë°•‰∏ÅÂ∞ÜÁ°Æ‰øùÊí≠ÊîæÂô®Âú®ËøôÈáåÈù¢ÊòæÁ§∫ -->
                        <div class="ratio ratio-16x9 bg-black rounded shadow overflow-hidden">
                            <video ref="videoPlayer" class="plyr" crossOrigin="anonymous" playsinline></video>

                            <!-- ‰ªÖ‰øùÁïôÂä†ËΩΩËΩ¨ÂúàÔºåÂÖ∂‰ªñÊèêÁ§∫ÂÖ®Âà† -->
                            <div v-if="loadingVideo"
                                class="d-flex align-items-center justify-content-center text-light h-100 position-absolute w-100 top-0"
                                style="background:rgba(0,0,0,0.6); z-index:10;">
                                <div class="spinner-border text-info me-2"></div>
                                <span>ËßÜÈ¢ëËß£Êûê‰∏≠...</span>
                            </div>
                        </div>

                        <!-- ÁßªÂä®Á´ØÊòæÁ§∫ÁöÑÊ†áÈ¢òÂíåÊåâÈíÆ (PCÁ´ØÈöêËóè) -->
                        <div class="d-lg-none mt-2">
                            <h4 class="fw-bold">{{ currentAnime.title }}</h4>
                            <button class="btn btn-sm mt-2"
                                :class="isFavorited(currentAnime.id) ? 'btn-danger' : 'btn-outline-danger'"
                                @click="toggleFavorite(currentAnime.id)">
                                {{ isFavorited(currentAnime.id) ? '‚ù§Ô∏è Â∑≤ËøΩÁï™' : 'ü§ç ËøΩÁï™' }}
                            </button>
                        </div>
                    </div>

                    <!-- Âè≥‰æßÔºö‰æßËæπÊ†è (Âç†ÂÆΩ 3/12) -->
                    <div class="col-lg-3 col-md-12">
                        <div class="card bg-dark border-secondary">
                            <div class="card-body p-3">
                                <!-- 1. Ê†áÈ¢òÂíåÊí≠Êîæ‰ø°ÊÅØ (‰Ωç‰∫éÊúÄ‰∏äÊñπ) -->
                                <div class="mb-3">
                                    <h4 class="fw-bold mb-1">{{ currentAnime.title }}</h4>
                                    <div class="text-muted small">
                                        <div v-if="currentEp" class="text-info mb-1 fw-bold">
                                            Ê≠£Âú®Êí≠Êîæ: {{ currentEp.full_title }}
                                        </div>
                                        <span>{{ currentAnime.year }} {{ currentAnime.season }}</span>
                                    </div>
                                </div>

                                <!-- 2. Áï™ÂâßÁÆÄÊä• (Êµ∑Êä•+Áä∂ÊÄÅ+ËøΩÁï™) -->
                                <div class="d-flex gap-3 mb-3">
                                    <div class="flex-shrink-0" style="width: 80px;">
                                        <img :src="currentAnime.poster || ''" class="img-fluid rounded"
                                            style="aspect-ratio: 2/3; object-fit: cover;">
                                    </div>
                                    <div class="flex-grow-1 d-flex flex-column gap-2"> <!-- ËøôÈáåÊîπÊàê‰∫Ü gap-2 ‰ª•‰æøËá™Âä®Èó¥Ë∑ù -->

                                        <!-- Áä∂ÊÄÅÊ†áÁ≠æ -->
                                        <div>
                                            <span class="badge"
                                                :class="(currentAnime.status && (currentAnime.status.includes('ËøûËΩΩ') || currentAnime.status.includes('Live'))) ? 'bg-info text-dark' : 'bg-secondary'">
                                                {{ (currentAnime.status && (currentAnime.status.includes('ËøûËΩΩ') || currentAnime.status.includes('Live'))) ? currentAnime.status : (currentAnime.year || 'Êú™Áü•') }}
                                            </span>
                                        </div>

                                        <!-- üî•üî•üî• ‰øÆÊîπÂêéÁöÑÔºö‰∏äÊ¨°Êí≠ÊîæËÆ∞ÂΩïÊåâÈíÆ üî•üî•üî• -->
                                        <!-- Êù°‰ª∂ËØ¥ÊòéÔºöÊúâËÆ∞ÂΩï ‰∏î ÈõÜÊï∞Â∑≤Âä†ËΩΩÂÆå ‰∏î ÂàóË°®‰∏ç‰∏∫Á©∫ ‰∏î ÂΩìÂâçÊú™ÂºÄÂßãÊí≠Êîæ -->
                                        <div v-if="lastWatchedEpisode && !loadingEps && episodes.length > 0 && !currentEp"
                                            class="resume-btn fade-in" @click="resumePlay">
                                            ‰∏äÊ¨°Êí≠ÊîæÂà∞ [{{ lastWatchedEpisode.title }}] {{
                                            formatTime(lastWatchedEpisode.time) }}
                                            <small>ÁÇπÂáªÁªßÁª≠Êí≠Êîæ ‚ñ∂</small>
                                        </div>

                                        <!-- ËøΩÁï™ÊåâÈíÆ -->
                                        <button class="btn btn-sm w-100"
                                            :class="isFavorited(currentAnime.id) ? 'btn-danger' : 'btn-outline-danger'"
                                            @click="toggleFavorite(currentAnime.id)">
                                            {{ isFavorited(currentAnime.id) ? '‚ù§Ô∏è Â∑≤ËøΩÁï™' : 'ü§ç ËøΩÁï™' }}
                                        </button>
                                    </div>
                                </div>

                                <hr class="border-secondary my-3">

                                <!-- 3. ÈÄâÈõÜÂàóË°® -->
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0 fw-bold">ÈÄâÈõÜ ({{ episodes.length }})</h6>
                                    <button class="btn btn-link btn-sm text-decoration-none text-muted"
                                        @click="episodes.reverse()">‚áÖ ÂÄíÂ∫è</button>
                                </div>

                                <!-- Áä∂ÊÄÅ1: Âä†ËΩΩ‰∏≠ -->
                                <div v-if="loadingEps" class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-secondary"></div>
                                </div>

                                <!-- Áä∂ÊÄÅ2: Âä†ËΩΩÂ§±Ë¥• (Êñ∞Â¢ûÈáçËØïÊåâÈíÆ) -->
                                <div v-else-if="loadingEpsError" class="text-center py-4">
                                    <p class="small text-danger mb-2">Âä†ËΩΩÂ§±Ë¥•</p>
                                    <button class="btn btn-sm btn-outline-warning"
                                        @click="fetchEpisodes(currentAnime.id)">
                                        ‚Üª ÈáçÊñ∞Âä†ËΩΩ
                                    </button>
                                </div>

                                <!-- Áä∂ÊÄÅ3: Ê≠£Â∏∏ÊòæÁ§∫ (ÁΩëÊ†ºÈÄâÈõÜÂå∫) -->
                                <div v-else class="episode-grid custom-scrollbar">
                                    <div v-for="ep in episodes" :key="ep.index" class="ep-btn" :class="{
                                            'active': currentEp && currentEp.index === ep.index,
                                            'watched': !currentEp && lastWatchedEpisode && lastWatchedEpisode.title === ep.title
                                        }" :title="ep.full_title" @click="playEp(ep)">
                                        {{ ep.title }}
                                    </div>
                                </div>

                                <!-- üî• Áï™Ââß‰ªãÁªçÂå∫Âüü (ÈõÜÊï∞Âä†ËΩΩÂÆåÊàêÂêéÊòæÁ§∫) -->
                                <div v-if="!loadingEps && episodes.length > 0 && descMap[currentAnime.title]"
                                    class="anime-description mt-5">
                                    <h6 class="mb-2 fw-bold text-muted">üìñ Áï™Ââß‰ªãÁªç</h6>
                                    <p class="small text-light" style="white-space: pre-line; line-height: 1.6;">{{
                                        descMap[currentAnime.title] }}</p>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/vue.global.js"></script>
    <script src="/static/js/axios.min.js"></script>
    <script src="/static/js/plyr.js"></script>
    <script src="/static/js/app.js"></script>
</body>

</html>